#!/bin/sh

#
# edit
#
# Find the "right" gvim server and send some files to it.
#

unset nofork
unset nogui
gvim=gvim

if [ "$1" = "--nofork" ]
then
	nofork="$1"
	shift
fi

# If DISPLAY is not set then we can cannot have a gvim server but
# we try to fallback using DBus before giving up and using vim
if [ -z $DISPLAY ]
then
	nogui=1
fi

# If TMUX is set and the fullscreen open is set then we also fallback to
# regular vim
if [ ! -z $TMUX ] && tmux show -gv @fullscreen > /dev/null 2> /dev/null
then
	nogui=1
fi

if [ ! -z $nogui ]
then
	if [ -z `which dvim` ] || [ ! -z $nofork ]
	then
		exec vim "$@"
	fi

	gvim="dvim"
fi


serverlist=`$gvim --serverlist`

uppercase () {
	echo "$@" | tr a-z- A-Z_
}

server_exists () {
	echo $serverlist | grep -F "`uppercase \"$1\"`" 2>&1 >/dev/null
}

if [ "$PWD" = "$HOME" ]
then
	# Special case any editor starting up in the home directory
	server=GVIM
else
	# Keep looking up the path to see if there is an editor we can
	# use. If not then start one named after the current directory.
	d="$PWD"
	while [ "$d" != "/" ]
	do
		server="`basename \"$d\"`"
		if server_exists "$server"
		then
			break
		fi

		d="`dirname \"$d\"`"
	done

	if [ "$d" = "/" ]
	then
		server="`basename \"$PWD\"`"
	fi
fi


if server_exists $server
then
	if [ $# -gt 0 ]
	then
		if [ -z $nofork ]
		then
			$gvim --servername "$server" --remote-tab "$@"
		else
			echo Waiting for tab to close... 
			$gvim --servername "$server" --remote-tab-wait "$@"
		fi
	else
		$gvim --servername "$server" --remote-send '<ESC>:tabnew<CR>:call foreground()<CR>'
	fi
else
	[ -z $nofork ] || echo Waiting for editor to close...
		$gvim $nofork --servername "$server" "$@"
fi
