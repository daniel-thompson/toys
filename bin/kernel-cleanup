#!/bin/sh

#
# kernel-cleanup
#
# Scan for installed kernels and provide a menu to the user allowing them to
# choose what to remove.
#
# Assumes kernels are managed as deb packages so it will only work on Debian
# (and derivatives)
#

# Check that whiptail is installed
if ! whiptail -v > /dev/null 2> /dev/null
then
    echo ERROR: whiptail is not installed
    exit 1
fi

# Check the terminal is big enough
if [ "$(stty size | cut -f1 -d' ')" -lt 21 ]
then
    echo ERROR: terminal must have at least 21 lines
    exit 2
fi

# Create a list of candidate kernels
kernels="$(ls /boot/vmlinuz-* | sed -e 's:^/boot/vmlinuz-\(.*\)$:linux-image-\1 "" off:')"

# Interact with the user to choose what to remove
remove=$(eval whiptail --checklist \"Select kernels to uninstall\" 20 78 12 ${kernels} 3>&1 1>&2 2>&3)

# Complete the removal
eval sudo apt remove ${remove}
